/**
 * API: Send Weekly Report
 * Gera e envia relat√≥rio semanal com insights
 * 
 * Executa: Domingos √†s 21h UTC (18h BRT)
 */

import { createClient } from '@supabase/supabase-js';
import ZulMessages from '../../../services/zulMessages.js';

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_KEY
);

// Fun√ß√£o para enviar mensagem WhatsApp
async function sendWhatsAppMessage(phone, message) {
  try {
    const response = await fetch(`https://graph.facebook.com/v18.0/${process.env.PHONE_ID}/messages`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.WHATSAPP_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        messaging_product: 'whatsapp',
        to: phone.startsWith('+') ? phone : `+55${phone}`,
        type: 'text',
        text: { body: message }
      })
    });

    if (!response.ok) {
      const error = await response.text();
      console.error('Erro ao enviar WhatsApp:', error);
      return false;
    }

    return true;
  } catch (error) {
    console.error('Erro na fun√ß√£o sendWhatsAppMessage:', error);
    return false;
  }
}

// Calcular in√≠cio da semana (domingo)
function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day;
  return new Date(d.setDate(diff));
}

// Calcular fim da semana (s√°bado)
function getWeekEnd(date) {
  const weekStart = getWeekStart(date);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekEnd.getDate() + 6);
  return weekEnd;
}

export default async function handler(req, res) {
  // Verificar m√©todo
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'M√©todo n√£o permitido' });
  }

  // Verificar autoriza√ß√£o
  const authHeader = req.headers.authorization;
  if (!authHeader || authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return res.status(401).json({ error: 'N√£o autorizado' });
  }

  try {
    console.log('üìä Iniciando gera√ß√£o de relat√≥rio semanal...');

    const zulMessages = new ZulMessages();
    const today = new Date();
    const weekStart = getWeekStart(today);
    const weekEnd = getWeekEnd(today);

    // Buscar todas as organiza√ß√µes ativas
    const { data: organizations, error: orgError } = await supabase
      .from('organizations')
      .select('id, name')
      .eq('is_active', true);

    if (orgError) throw orgError;

    const reports = [];

    for (const organization of organizations || []) {
      console.log(`üìà Gerando relat√≥rio para organiza√ß√£o: ${organization.name}`);

      try {
        // Buscar dados da semana atual usando fun√ß√£o SQL
        const { data: weekData, error: weekError } = await supabase.rpc('get_weekly_summary', {
          org_id: organization.id,
          week_start_date: weekStart.toISOString().split('T')[0]
        });

        if (weekError) {
          console.error('Erro ao buscar dados semanais:', weekError);
          continue;
        }

        if (!weekData || weekData.length === 0) {
          console.log(`‚ö†Ô∏è Nenhum dado encontrado para ${organization.name}`);
          continue;
        }

        const weekSummary = weekData[0];
        const { total_spent, category_totals, cost_center_totals, expense_count } = weekSummary;

        // Buscar dados da semana anterior para compara√ß√£o
        const prevWeekStart = new Date(weekStart);
        prevWeekStart.setDate(prevWeekStart.getDate() - 7);
        const prevWeekEnd = new Date(weekEnd);
        prevWeekEnd.setDate(prevWeekEnd.getDate() - 7);

        const { data: prevWeekData } = await supabase.rpc('get_weekly_summary', {
          org_id: organization.id,
          week_start_date: prevWeekStart.toISOString().split('T')[0]
        });

        const prevWeekSummary = prevWeekData && prevWeekData.length > 0 ? prevWeekData[0] : null;
        const prevTotalSpent = prevWeekSummary ? prevWeekSummary.total_spent : 0;

        // Calcular mudan√ßa percentual
        const changePercent = prevTotalSpent > 0 ? 
          ((total_spent - prevTotalSpent) / prevTotalSpent) * 100 : 0;

        // Preparar top categorias
        const topCategories = [];
        if (category_totals) {
          const categories = Object.entries(category_totals)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 3);
          
          categories.forEach(([name, amount], index) => {
            const percentage = total_spent > 0 ? (amount / total_spent) * 100 : 0;
            topCategories.push({
              name,
              amount,
              percentage: percentage.toFixed(1),
              emoji: getCategoryEmoji(name)
            });
          });
        }

        // Buscar usu√°rios da organiza√ß√£o que devem receber relat√≥rio
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('id, name, whatsapp_phone')
          .eq('organization_id', organization.id)
          .eq('is_active', true)
          .not('whatsapp_phone', 'is', null);

        if (usersError) {
          console.error('Erro ao buscar usu√°rios:', usersError);
          continue;
        }

        // Verificar se j√° foi enviado relat√≥rio esta semana
        const weekStartStr = weekStart.toISOString().split('T')[0];
        const { data: existingReports } = await supabase
          .from('notification_history')
          .select('id')
          .eq('user_id', users[0]?.id)
          .eq('channel', 'whatsapp')
          .gte('sent_at', `${weekStartStr}T00:00:00`)
          .like('delivery_status', 'sent');

        if (existingReports && existingReports.length > 0) {
          console.log(`‚ö†Ô∏è Relat√≥rio semanal j√° enviado esta semana para ${organization.name}`);
          continue;
        }

        // Enviar relat√≥rio para todos os usu√°rios
        for (const user of users || []) {
          try {
            // Gerar mensagem de relat√≥rio
            const message = zulMessages.weeklyReport(
              user.name,
              total_spent,
              topCategories,
              {
                percentChange: changePercent,
                previousTotal: prevTotalSpent
              }
            );

            // Enviar WhatsApp
            console.log(`üì± Enviando relat√≥rio semanal para ${user.name}`);
            const sent = await sendWhatsAppMessage(user.whatsapp_phone, message);

            if (sent) {
              // Criar notifica√ß√£o in-app
              const { error: notificationError } = await supabase
                .from('notifications')
                .insert({
                  user_id: user.id,
                  organization_id: organization.id,
                  type: 'weekly_report',
                  title: 'Relat√≥rio Semanal',
                  message: `Total gasto: R$ ${total_spent.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`,
                  data: {
                    week_start: weekStart.toISOString().split('T')[0],
                    week_end: weekEnd.toISOString().split('T')[0],
                    total_spent,
                    expense_count,
                    change_percent: changePercent,
                    top_categories: topCategories
                  },
                  sent_via: 'whatsapp',
                  priority: 'normal'
                });

              if (notificationError) {
                console.error('Erro ao criar notifica√ß√£o:', notificationError);
              }

              // Registrar hist√≥rico de envio
              const { error: historyError } = await supabase
                .from('notification_history')
                .insert({
                  user_id: user.id,
                  sent_at: new Date().toISOString(),
                  delivery_status: 'sent',
                  channel: 'whatsapp'
                });

              if (historyError) {
                console.error('Erro ao registrar hist√≥rico:', historyError);
              }

              reports.push({
                user_id: user.id,
                user_name: user.name,
                organization_name: organization.name,
                total_spent,
                expense_count,
                change_percent: changePercent.toFixed(1),
                sent: true
              });

              console.log(`‚úÖ Relat√≥rio enviado para ${user.name}`);
            } else {
              console.log(`‚ùå Falha ao enviar relat√≥rio para ${user.name}`);
              
              reports.push({
                user_id: user.id,
                user_name: user.name,
                organization_name: organization.name,
                total_spent,
                expense_count,
                change_percent: changePercent.toFixed(1),
                sent: false
              });
            }

            // Pequena pausa entre envios
            await new Promise(resolve => setTimeout(resolve, 1000));

          } catch (userError) {
            console.error(`Erro ao processar usu√°rio ${user.name}:`, userError);
          }
        }

      } catch (orgError) {
        console.error(`Erro ao processar organiza√ß√£o ${organization.name}:`, orgError);
      }
    }

    console.log(`‚úÖ Gera√ß√£o de relat√≥rio semanal conclu√≠da. ${reports.length} relat√≥rios processados.`);

    return res.status(200).json({
      success: true,
      message: `${reports.length} relat√≥rios semanais processados`,
      count: reports.length,
      reports: reports.filter(r => r.sent),
      failed: reports.filter(r => !r.sent).length
    });

  } catch (error) {
    console.error('‚ùå Erro ao processar relat√≥rio semanal:', error);
    return res.status(500).json({
      success: false,
      error: 'Erro interno do servidor',
      message: error.message
    });
  }
}

// Fun√ß√£o auxiliar para emoji de categoria
function getCategoryEmoji(categoryName) {
  const emojis = {
    'Alimenta√ß√£o': 'üçΩÔ∏è',
    'Supermercado': 'üõí',
    'Mercado': 'üõí',
    'Transporte': 'üöó',
    'Combust√≠vel': '‚õΩ',
    'Sa√∫de': 'üíä',
    'Farm√°cia': 'üíä',
    'Beleza': 'üíÑ',
    'Lazer': 'üéâ',
    'Contas': 'üìÑ',
    'Casa': 'üè†',
    'Educa√ß√£o': 'üìö',
    'Vestu√°rio': 'üëï',
    'Outros': 'üí∞'
  };
  
  return emojis[categoryName] || 'üí∞';
}
