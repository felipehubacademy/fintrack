# üìã C√ìDIGO COMPLETO - ZUL NO WHATSAPP

Este documento lista todos os arquivos e seus c√≥digos completos envolvidos no fluxo do ZUL no WhatsApp.

---

## üéØ ARQUIVOS PRINCIPAIS (Ordem de Execu√ß√£o)

### 1. **backend/api/webhook.js** (270 linhas)
**Fun√ß√£o:** Ponto de entrada do WhatsApp - recebe webhook e chama ZulAssistant

**C√≥digo completo:** Ver abaixo

---

### 2. **backend/services/zulAssistant.js** (1884 linhas)
**Fun√ß√£o:** C√©rebro do ZUL - l√≥gica completa de conversa√ß√£o e salvamento de despesas

**Se√ß√µes principais:**
- `normalizeText()` - Normaliza√ß√£o de texto (case/acentos)
- `extractCoreDescription()` - Extra√ß√£o de descri√ß√£o core
- `pickVariation()` - Sele√ß√£o de varia√ß√µes de mensagens
- `getFirstName()` - Extra√ß√£o de primeiro nome
- `save_expense` (dentro de `context.saveExpense`) - Salva despesa com valida√ß√µes
  - Normaliza√ß√£o de payment_method
  - Busca de cost_center_id (com suporte a primeiro nome)
  - Infer√™ncia autom√°tica de categoria (catHints + synonyms)
  - Valida√ß√£o obrigat√≥ria de categoria
  - Subfluxo de cart√£o de cr√©dito (cart√£o + parcelas)
  - Cria√ß√£o de parcelas futuras
  - Mensagem de confirma√ß√£o
- `sendConversationalMessage()` - Conversa com GPT-4o-mini
- `getConversationalInstructions()` - Prompt do GPT (1400+ linhas de instru√ß√µes)
- `getFunctions()` - Fun√ß√µes dispon√≠veis para GPT
- `handleFunctionCall()` - Processa chamadas de fun√ß√µes
- `processMessage()` - M√©todo principal de processamento

**C√≥digo completo:** Ver abaixo

---

### 3. **backend/services/whatsapp.js** (67 linhas)
**Fun√ß√£o:** Utilit√°rios para enviar mensagens via WhatsApp API

**C√≥digo completo:** Ver abaixo

---

### 4. **backend/routes/whatsapp.js** (60 linhas)
**Fun√ß√£o:** Rotas Express alternativas (principalmente para respostas de bot√µes)

**C√≥digo completo:** Ver abaixo

---

### 5. **backend/services/openaiService.js** (278 linhas)
**Fun√ß√£o:** Servi√ßo OpenAI (usado por outros servi√ßos, n√£o diretamente pelo fluxo WhatsApp)

**C√≥digo completo:** Ver abaixo

---

### 6. **backend/services/supabase.js** (116 linhas)
**Fun√ß√£o:** Cliente Supabase e fun√ß√µes auxiliares

**C√≥digo completo:** Ver abaixo

---

## üìù C√ìDIGOS COMPLETOS

### backend/api/webhook.js

```javascript
/**
 * Webhook FinTrack V2 (backend/api) - VERSION B2 (CONSOLIDATED)
 * Consolidado para usar apenas ZulAssistant
 */

import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

const WHATSAPP_API_URL = 'https://graph.facebook.com/v18.0';

/**
 * Buscar usu√°rio por telefone
 */
async function getUserByPhone(phone) {
  try {
    const normalized = String(phone || '').replace(/\D/g, '');
    
    const { data: user, error } = await supabase
      .from('users')
      .select('*')
      .ilike('phone', `%${normalized}%`)
      .eq('is_active', true)
      .maybeSingle();

    if (error || !user) return null;
    
    const { data: organization } = await supabase
      .from('organizations')
      .select('*')
      .eq('id', user.organization_id)
      .single();

    const { data: costCenters } = await supabase
      .from('cost_centers')
      .select('*')
      .eq('organization_id', user.organization_id)
      .eq('is_active', true);

    return {
      ...user,
      organization,
      cost_centers: costCenters || []
    };
  } catch (error) {
    console.error('‚ùå Erro ao buscar usu√°rio:', error);
    return null;
  }
}

/**
 * Enviar mensagem WhatsApp
 */
async function sendWhatsAppMessage(to, message) {
  try {
    const axios = (await import('axios')).default;
    const phoneNumberId = process.env.PHONE_ID;
    const token = process.env.WHATSAPP_TOKEN;
    
    await axios.post(
      `${WHATSAPP_API_URL}/${phoneNumberId}/messages`,
      {
        messaging_product: 'whatsapp',
        to: to,
        type: 'text',
        text: { body: message }
      },
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('‚úÖ Mensagem WhatsApp enviada para', to);
  } catch (error) {
    console.error('‚ùå Erro ao enviar WhatsApp:', error);
  }
}

// Process webhook synchronously com logs detalhados
async function processWebhook(body) {
  console.log('üîÑ [B1][DEBUG] Starting processWebhook...');
  try {
    const entry = body.entry?.[0];
    const change = entry?.changes?.[0];
    const value = change?.value;

    // Process messages
    if (value?.messages) {
      for (const message of value.messages) {
        if (message.type === 'text') {
          try {
            // Fast path para testes
            if (message.id?.includes('test_') || process.env.WEBHOOK_DRY_RUN === '1') {
              continue;
            }

            // Import din√¢mico do ZulAssistant
            const { default: ZulAssistant } = await import('../services/zulAssistant.js');
            const zul = new ZulAssistant();

            // Buscar usu√°rio por telefone
            const user = await getUserByPhone(message.from);
            
            if (!user) {
              await sendWhatsAppMessage(message.from, 
                'Opa! N√£o consegui te identificar aqui. ü§î\n\nVoc√™ j√° fez parte de uma organiza√ß√£o no MeuAzul√£o? Se sim, verifica se teu n√∫mero est√° cadastrado direitinho!'
              );
              continue;
            }

            // Buscar cart√µes dispon√≠veis
            const { data: cards } = await supabase
              .from('cards')
              .select('name')
              .eq('organization_id', user.organization_id)
              .eq('is_active', true);
            
            // Processar mensagem com ZulAssistant
            const context = {
              userName: user.name,
              userId: user.id,
              organizationId: user.organization_id,
              availableCards: cards?.map(c => c.name) || []
            };
            
            const result = await zul.processMessage(
              message.text.body,
              user.id,
              user.name,
              message.from,
              context
            );
            
            // Enviar resposta via WhatsApp
            if (result && result.message) {
              await sendWhatsAppMessage(message.from, result.message);
            }

          } catch (zulError) {
            console.error('‚ùå [B2][DEBUG] Error in ZulAssistant:', zulError);
            await sendWhatsAppMessage(message.from, 
              'Ops! Tive um problema aqui. üòÖ\n\nTenta de novo? Se continuar, melhor falar com o suporte!'
            );
          }
        }
      }
    }

    // Process status updates
    if (value?.statuses) {
      for (const status of value.statuses) {
        console.log(`üìä [B1] Message status: ${status.status} for ${status.id}`);
      }
    }

  } catch (error) {
    console.error('‚ùå [B1] Error processing webhook:', error);
  }
}

export default async function handler(req, res) {
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'GET') {
    const mode = req.query['hub.mode'];
    const token = req.query['hub.verify_token'];
    const challenge = req.query['hub.challenge'];

    if (mode === 'subscribe' && token === 'fintrack_verify_token') {
      return res.status(200).send(challenge);
    }
    if (challenge) {
      return res.status(200).send(challenge);
    }
    return res.status(403).send('Forbidden');
  }

  if (req.method === 'POST') {
    try {
      await processWebhook(req.body);
      return res.status(200).send('OK');
    } catch (error) {
      return res.status(500).send('Error');
    }
  }

  return res.status(405).send('Method Not Allowed');
}
```

---

### backend/services/zulAssistant.js

**‚ö†Ô∏è Arquivo muito grande (1884 linhas)** - Ver arquivo original completo em: `backend/services/zulAssistant.js`

**Principais m√©todos:**
- `normalizeText(str)` - Linhas 34-41
- `extractCoreDescription(text)` - Linhas 46-82
- `pickVariation(variations, seed)` - Linhas 88-98
- `getFirstName(context)` - Linhas 103-106
- `context.saveExpense(args)` - Linhas 510-1160 (fun√ß√£o completa de salvamento)
- `sendConversationalMessage()` - Linhas 506-1273
- `getConversationalInstructions(context)` - Linhas 1404-1609 (prompt do GPT)
- `getFunctions()` - Linhas 1614-1655
- `handleFunctionCall()` - Linhas 1810-1827
- `processMessage()` - Linhas 1832-1871

---

### backend/services/whatsapp.js

```javascript
import axios from 'axios';

const WHATSAPP_API_URL = 'https://graph.facebook.com/v18.0';

/**
 * Enviar mensagem de texto via WhatsApp
 */
export async function sendTextMessage(phoneNumberId, to, message) {
  try {
    const response = await axios.post(
      `${WHATSAPP_API_URL}/${phoneNumberId}/messages`,
      {
        messaging_product: 'whatsapp',
        to: to,
        type: 'text',
        text: {
          body: message
        }
      },
      {
        headers: {
          'Authorization': `Bearer ${process.env.WHATSAPP_ACCESS_TOKEN}`,
          'Content-Type': 'application/json'
        }
      }
    );

    return response.data;
  } catch (error) {
    console.error('Erro ao enviar mensagem WhatsApp:', error.response?.data || error.message);
    throw error;
  }
}

/**
 * Processar resposta de bot√£o do WhatsApp
 */
export function parseButtonReply(body) {
  try {
    const entry = body.entry?.[0];
    const changes = entry?.changes?.[0];
    const value = changes?.value;
    const messages = value?.messages;
    
    if (!messages || messages.length === 0) {
      return null;
    }

    const message = messages[0];
    const buttonReply = message.interactive?.button_reply;
    
    if (buttonReply) {
      return {
        messageId: message.id,
        from: message.from,
        buttonId: buttonReply.id,
        buttonTitle: buttonReply.title,
        timestamp: message.timestamp
      };
    }

    return null;
  } catch (error) {
    console.error('Erro ao processar resposta de bot√£o:', error);
    return null;
  }
}
```

---

### backend/routes/whatsapp.js

```javascript
import express from 'express';
import { parseButtonReply, sendTextMessage } from '../services/whatsapp.js';
import { updateExpenseOwner } from '../services/supabase.js';

const router = express.Router();

/**
 * GET /webhook
 * Verify webhook for WhatsApp
 */
router.get('/webhook', (req, res) => {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];

  const VERIFY_TOKEN = process.env.WHATSAPP_VERIFY_TOKEN || 'fintrack_verify_token';

  if (mode === 'subscribe' && token === VERIFY_TOKEN) {
    console.log('Webhook verified');
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

/**
 * POST /webhook
 * Receive WhatsApp button responses and update expense owner
 */
router.post('/webhook', async (req, res) => {
  try {
    const body = req.body;
    
    // Quickly respond to WhatsApp to avoid timeout
    res.sendStatus(200);
    
    // Parse button reply
    const reply = parseButtonReply(body);
    
    if (reply) {
      const { expenseId, owner, split } = reply;
      
      // Update expense in Supabase
      await updateExpenseOwner(expenseId, owner, split);
      
      // Send confirmation message
      await sendTextMessage(
        `‚úÖ Despesa atribu√≠da a: ${owner}${split ? ' (compartilhado)' : ''}`
      );
      
      console.log(`Updated expense ${expenseId} - Owner: ${owner}, Split: ${split}`);
    }
  } catch (error) {
    console.error('Error processing webhook:', error);
  }
});

export default router;
```

---

## üîÑ FLUXO COMPLETO

```
WhatsApp Webhook (Facebook)
    ‚Üì
backend/api/webhook.js
    ‚îú‚îÄ getUserByPhone() - Busca usu√°rio no Supabase
    ‚îú‚îÄ Busca cart√µes dispon√≠veis da organiza√ß√£o
    ‚îî‚îÄ Chama zul.processMessage()
         ‚Üì
backend/services/zulAssistant.js
    ‚îú‚îÄ processMessage() - Detecta se √© WhatsApp ou Web
    ‚îú‚îÄ sendConversationalMessage() - Converte com GPT-4o-mini
    ‚îÇ   ‚îú‚îÄ getConversationalInstructions() - Prompt do GPT (1400+ linhas)
    ‚îÇ   ‚îú‚îÄ Carrega hist√≥rico da conversa do banco
    ‚îÇ   ‚îú‚îÄ Chama GPT com function calling
    ‚îÇ   ‚îî‚îÄ Salva no hist√≥rico
    ‚îú‚îÄ handleFunctionCall() - Processa chamadas de fun√ß√µes
    ‚îÇ   ‚îî‚îÄ save_expense (context.saveExpense)
    ‚îÇ       ‚îú‚îÄ Normaliza payment_method
    ‚îÇ       ‚îú‚îÄ Busca cost_center_id (primeiro nome suportado)
    ‚îÇ       ‚îú‚îÄ Infer√™ncia autom√°tica de categoria (catHints + synonyms)
    ‚îÇ       ‚îú‚îÄ Valida√ß√£o obrigat√≥ria de categoria
    ‚îÇ       ‚îú‚îÄ Subfluxo de cart√£o de cr√©dito
    ‚îÇ       ‚îú‚îÄ Cria√ß√£o de parcelas futuras
    ‚îÇ       ‚îî‚îÄ Mensagem de confirma√ß√£o formatada
    ‚îî‚îÄ Retorna resposta
         ‚Üì
backend/api/webhook.js
    ‚îî‚îÄ sendWhatsAppMessage() - Envia resposta via WhatsApp API
```

---

## üìä ESTRUTURA DE DADOS

### Tabelas do Banco (Supabase):
- `expenses` - Despesas registradas
- `budget_categories` - Categorias (org + globais)
- `cost_centers` - Centros de custo (respons√°veis)
- `cards` - Cart√µes de cr√©dito da organiza√ß√£o
- `conversation_state` - Estado das conversas (hist√≥rico)

### Vari√°veis de Ambiente Necess√°rias:
- `SUPABASE_URL`
- `SUPABASE_SERVICE_KEY`
- `OPENAI_API_KEY`
- `OPENAI_ASSISTANT_ID` (opcional, cria dinamicamente se n√£o existir)
- `WHATSAPP_TOKEN`
- `PHONE_ID`

---

## ‚ö†Ô∏è OBSERVA√á√ïES

1. **zulAssistant.js** √© o arquivo principal (1884 linhas) - cont√©m toda a l√≥gica
2. **webhook.js** √© o ponto de entrada - recebe mensagens do WhatsApp
3. **smartConversation.js** est√° desabilitado (n√£o usado no fluxo atual)
4. **zulMessages.js** n√£o √© usado no fluxo "puro" (GPT gera mensagens)

---

## üìå PR√ìXIMOS PASSOS

Para ver os c√≥digos completos:
1. **webhook.js**: Ver arquivo acima
2. **zulAssistant.js**: Ver arquivo original em `backend/services/zulAssistant.js` (1884 linhas)
3. **whatsapp.js**: Ver arquivo acima
4. **routes/whatsapp.js**: Ver arquivo acima

