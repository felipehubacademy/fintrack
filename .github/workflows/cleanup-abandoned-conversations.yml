name: Cleanup Abandoned Conversations

# Roda diariamente √†s 3h da manh√£ (hor√°rio UTC)
on:
  schedule:
    - cron: '0 3 * * *'  # 3:00 AM UTC = 00:00 AM Bras√≠lia
  workflow_dispatch:  # Permite execu√ß√£o manual

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd backend
          npm install

      - name: Check secrets
        run: |
          if [ -z "${{ secrets.SUPABASE_URL }}" ]; then
            echo "‚ùå SUPABASE_URL n√£o configurado no GitHub Secrets"
            echo "üí° Configure em: Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          if [ -z "${{ secrets.SUPABASE_SERVICE_KEY }}" ]; then
            echo "‚ùå SUPABASE_SERVICE_KEY n√£o configurado no GitHub Secrets"
            echo "üí° Configure em: Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          echo "‚úÖ Secrets configurados"

      - name: Run cleanup script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          if [ ! -f "backend/scripts/cleanup-abandoned-conversations.js" ]; then
            echo "‚ö†Ô∏è Script cleanup-abandoned-conversations.js n√£o encontrado"
            echo "üí° Pulando step (script n√£o existe)"
            exit 0
          fi
          
          node backend/scripts/cleanup-abandoned-conversations.js

      - name: Summary
        run: echo "‚úÖ Limpeza de conversas abandonadas conclu√≠da!"

