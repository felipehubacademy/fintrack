# Guia: Adicionar Novas Funcionalidades ao ZUL

Este documento explica como expandir as capacidades do ZUL para incluir:
- ‚úÖ Registrar entradas/receitas (incomes)
- ‚úÖ Enviar resumo de despesas
- ‚úÖ Resumo por categoria
- ‚úÖ Consultas como "quanto j√° gastei de alimenta√ß√£o esse m√™s?"

---

## üìã Estrutura Atual

### 1. Fun√ß√µes Dispon√≠veis
**Arquivo:** `backend/services/zulAssistant.js`

As fun√ß√µes s√£o definidas no m√©todo `getFunctions()` (linha ~1431):
```javascript
getFunctions() {
  return [
    {
      name: 'save_expense',
      description: 'Salvar despesa...',
      parameters: { ... }
    }
  ];
}
```

### 2. Processamento de Fun√ß√µes
As fun√ß√µes chamadas pelo GPT s√£o processadas em `handleFunctionCall()` (linha ~1631):
```javascript
async handleFunctionCall(functionName, functionArgs, context) {
  if (functionName === 'save_expense') {
    // Processar despesa
  }
  // Adicionar novos cases aqui
}
```

---

## üöÄ Implementa√ß√£o Passo a Passo

### PASSO 1: Adicionar Nova Fun√ß√£o ao `getFunctions()`

```javascript
getFunctions() {
  return [
    {
      name: 'save_expense',
      // ... existente
    },
    // ‚úÖ NOVA FUN√á√ÉO: Registrar Entrada/Receita
    {
      name: 'save_income',
      description: 'Registrar entrada/receita quando o usu√°rio mencionar valores recebidos (ex: "recebi comiss√£o de 200 reais", "sal√°rio", "freelance").',
      parameters: {
        type: 'object',
        properties: {
          amount: {
            type: 'number',
            description: 'Valor num√©rico da entrada/receita'
          },
          description: {
            type: 'string',
            description: 'Descri√ß√£o da entrada (ex: "comiss√£o", "sal√°rio", "freelance", "venda")'
          },
          category: {
            type: 'string',
            description: 'Categoria da entrada (ex: "Sal√°rio", "Comiss√£o", "Freelance", "Venda")'
          },
          account_name: {
            type: 'string',
            description: 'Nome da conta banc√°ria onde o dinheiro foi recebido (ex: "Nubank", "C6"). Se n√£o informado, usar conta padr√£o.'
          },
          responsible: {
            type: 'string',
            description: 'Quem recebeu: nome exato ou "eu"'
          },
          date: {
            type: 'string',
            description: 'Data da entrada no formato YYYY-MM-DD (opcional, default: hoje)'
          }
        },
        required: ['amount', 'description', 'responsible']
      }
    },
    // ‚úÖ NOVA FUN√á√ÉO: Obter Resumo de Despesas
    {
      name: 'get_expenses_summary',
      description: 'Obter resumo de despesas quando o usu√°rio perguntar "quanto gastei?", "resumo de despesas", "quanto j√° gastei esse m√™s?", etc.',
      parameters: {
        type: 'object',
        properties: {
          period: {
            type: 'string',
            description: 'Per√≠odo: "hoje", "esta_semana", "este_mes", "mes_anterior", ou data espec√≠fica (YYYY-MM)',
            enum: ['hoje', 'esta_semana', 'este_mes', 'mes_anterior']
          },
          category: {
            type: 'string',
            description: 'Categoria espec√≠fica para filtrar (opcional, ex: "Alimenta√ß√£o", "Transporte"). Se n√£o informado, retorna todas as categorias.'
          }
        },
        required: ['period']
      }
    },
    // ‚úÖ NOVA FUN√á√ÉO: Resumo por Categoria
    {
      name: 'get_category_summary',
      description: 'Obter resumo de despesas por categoria quando o usu√°rio perguntar "quanto gastei de X?", "resumo de alimenta√ß√£o", etc.',
      parameters: {
        type: 'object',
        properties: {
          category: {
            type: 'string',
            description: 'Nome da categoria (ex: "Alimenta√ß√£o", "Transporte", "Sa√∫de")'
          },
          period: {
            type: 'string',
            description: 'Per√≠odo: "hoje", "esta_semana", "este_mes", "mes_anterior"',
            enum: ['hoje', 'esta_semana', 'este_mes', 'mes_anterior']
          }
        },
        required: ['category', 'period']
      }
    }
  ];
}
```

---

### PASSO 2: Implementar Handlers no `handleFunctionCall()`

```javascript
async handleFunctionCall(functionName, functionArgs, context) {
  console.log(`üîß [FUNCTION] ${functionName} com args:`, functionArgs);
  
  if (functionName === 'save_expense') {
    return await context.saveExpense(functionArgs);
  }
  
  // ‚úÖ NOVO HANDLER: Salvar Entrada
  if (functionName === 'save_income') {
    return await this.saveIncome(functionArgs, context);
  }
  
  // ‚úÖ NOVO HANDLER: Resumo de Despesas
  if (functionName === 'get_expenses_summary') {
    return await this.getExpensesSummary(functionArgs, context);
  }
  
  // ‚úÖ NOVO HANDLER: Resumo por Categoria
  if (functionName === 'get_category_summary') {
    return await this.getCategorySummary(functionArgs, context);
  }
  
  return {
    success: false,
    message: 'Fun√ß√£o n√£o reconhecida'
  };
}
```

---

### PASSO 3: Implementar M√©todos

#### 3.1. `saveIncome()` - Registrar Entrada

```javascript
async saveIncome(args, context) {
  try {
    const { amount, description, category, account_name, responsible, date } = args;
    
    // Normalizar owner (mapear "eu" para nome do usu√°rio)
    let owner = responsible;
    if (this.normalizeText(owner) === 'eu') {
      owner = context.userName || owner;
    }
    
    // Buscar cost_center_id
    let costCenterId = null;
    if (owner && !this.normalizeText(owner).includes('compartilhado')) {
      const { data: centers } = await supabase
        .from('cost_centers')
        .select('id, name')
        .eq('organization_id', context.organizationId);
      
      if (centers && centers.length) {
        const ownerNorm = this.normalizeText(owner);
        const center = centers.find(c => {
          const n = this.normalizeText(c.name);
          return n === ownerNorm || n.includes(ownerNorm) || ownerNorm.includes(n);
        });
        
        if (center) {
          costCenterId = center.id;
          owner = center.name;
        }
      }
    }
    
    // Buscar bank_account_id se account_name foi informado
    let bankAccountId = null;
    if (account_name) {
      const { data: accounts } = await supabase
        .from('bank_accounts')
        .select('id, name')
        .eq('organization_id', context.organizationId)
        .eq('is_active', true);
      
      if (accounts && accounts.length) {
        const accountNorm = this.normalizeText(account_name);
        const account = accounts.find(a => {
          const n = this.normalizeText(a.name);
          return n === accountNorm || n.includes(accountNorm);
        });
        
        if (account) {
          bankAccountId = account.id;
        }
      }
    }
    
    // Preparar dados da entrada
    const incomeData = {
      amount: parseFloat(amount),
      description: description,
      date: date || new Date().toISOString().split('T')[0],
      category: category || 'Outros',
      cost_center_id: costCenterId,
      organization_id: context.organizationId,
      user_id: context.userId,
      status: 'confirmed',
      is_shared: false,
      source: 'whatsapp'
    };
    
    // Salvar entrada
    const { data, error } = await supabase
      .from('incomes')
      .insert(incomeData)
      .select()
      .single();
    
    if (error) {
      throw error;
    }
    
    // Se bank_account_id foi informado, criar transa√ß√£o banc√°ria
    if (bankAccountId) {
      // Buscar saldo atual
      const { data: account } = await supabase
        .from('bank_accounts')
        .select('balance')
        .eq('id', bankAccountId)
        .single();
      
      const newBalance = (parseFloat(account.balance) || 0) + parseFloat(amount);
      
      // Atualizar saldo
      await supabase
        .from('bank_accounts')
        .update({ balance: newBalance })
        .eq('id', bankAccountId);
      
      // Criar transa√ß√£o
      await supabase
        .from('bank_account_transactions')
        .insert({
          bank_account_id: bankAccountId,
          transaction_type: 'income_deposit',
          amount: parseFloat(amount),
          description: description,
          date: incomeData.date,
          balance_after: newBalance,
          income_id: data.id,
          organization_id: context.organizationId,
          user_id: context.userId
        });
    }
    
    // Formatar resposta
    const amountFormatted = Number(amount).toLocaleString('pt-BR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    
    const dateDisplay = incomeData.date === new Date().toISOString().split('T')[0]
      ? 'Hoje'
      : new Date(incomeData.date + 'T00:00:00').toLocaleDateString('pt-BR');
    
    const accountDisplay = bankAccountId ? `\n${account_name}` : '';
    
    return {
      success: true,
      message: `Entrada registrada! ‚úÖ\nR$ ${amountFormatted} - ${description}\n${category || 'Sem categoria'}${accountDisplay}\n${owner}\n${dateDisplay}`
    };
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar entrada:', error);
    return {
      success: false,
      message: 'Ops! Tive um problema ao registrar a entrada. üòÖ'
    };
  }
}
```

#### 3.2. `getExpensesSummary()` - Resumo de Despesas

```javascript
async getExpensesSummary(args, context) {
  try {
    const { period, category } = args;
    
    // Calcular datas baseado no per√≠odo
    const today = new Date();
    let startDate, endDate;
    
    switch (period) {
      case 'hoje':
        startDate = new Date(today);
        endDate = new Date(today);
        break;
      case 'esta_semana':
        const dayOfWeek = today.getDay();
        startDate = new Date(today);
        startDate.setDate(today.getDate() - dayOfWeek);
        endDate = new Date(today);
        break;
      case 'este_mes':
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        break;
      case 'mes_anterior':
        startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        endDate = new Date(today.getFullYear(), today.getMonth(), 0);
        break;
      default:
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        endDate = new Date(today);
    }
    
    // Construir query
    let query = supabase
      .from('expenses')
      .select('amount, category')
      .eq('organization_id', context.organizationId)
      .eq('status', 'confirmed')
      .gte('date', startDate.toISOString().split('T')[0])
      .lte('date', endDate.toISOString().split('T')[0]);
    
    if (category) {
      query = query.eq('category', category);
    }
    
    const { data: expenses, error } = await query;
    
    if (error) throw error;
    
    // Calcular total
    const total = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
    const totalFormatted = total.toLocaleString('pt-BR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
    
    // Agrupar por categoria se n√£o foi filtrado
    let response = `üí∞ **Resumo de Despesas** (${this.formatPeriod(period)})\n\n`;
    
    if (category) {
      response += `Total em ${category}: R$ ${totalFormatted}\n`;
      response += `(${expenses.length} despesa${expenses.length !== 1 ? 's' : ''})`;
    } else {
      // Agrupar por categoria
      const byCategory = {};
      expenses.forEach(e => {
        const cat = e.category || 'Sem categoria';
        byCategory[cat] = (byCategory[cat] || 0) + parseFloat(e.amount || 0);
      });
      
      response += `**Total: R$ ${totalFormatted}**\n\n`;
      
      // Ordenar por valor (maior primeiro)
      const sorted = Object.entries(byCategory)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // Top 10
      
      sorted.forEach(([cat, value]) => {
        const percent = ((value / total) * 100).toFixed(1);
        response += `‚Ä¢ ${cat}: R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} (${percent}%)\n`;
      });
      
      response += `\n(${expenses.length} despesa${expenses.length !== 1 ? 's' : ''} no total)`;
    }
    
    return {
      success: true,
      message: response
    };
    
  } catch (error) {
    console.error('‚ùå Erro ao buscar resumo:', error);
    return {
      success: false,
      message: 'Ops! Tive um problema ao buscar o resumo. üòÖ'
    };
  }
}

// Helper para formatar per√≠odo
formatPeriod(period) {
  const map = {
    'hoje': 'Hoje',
    'esta_semana': 'Esta Semana',
    'este_mes': 'Este M√™s',
    'mes_anterior': 'M√™s Anterior'
  };
  return map[period] || period;
}
```

#### 3.3. `getCategorySummary()` - Resumo por Categoria

```javascript
async getCategorySummary(args, context) {
  try {
    const { category, period } = args;
    
    // Reutilizar l√≥gica de getExpensesSummary
    const summaryResult = await this.getExpensesSummary({ period, category }, context);
    
    if (!summaryResult.success) {
      return summaryResult;
    }
    
    // Adicionar detalhes adicionais se necess√°rio
    const response = summaryResult.message.replace(
      `Total em ${category}:`,
      `Voc√™ gastou em ${category}:`
    );
    
    return {
      success: true,
      message: response
    };
    
  } catch (error) {
    console.error('‚ùå Erro ao buscar resumo por categoria:', error);
    return {
      success: false,
      message: 'Ops! Tive um problema ao buscar o resumo. üòÖ'
    };
  }
}
```

---

### PASSO 4: Atualizar Prompt do ZUL

Adicionar no `getConversationalInstructions()`:

```javascript
// Adicionar ap√≥s a regra 13 (SOBRE VOC√ä):

14. **REGISTRAR ENTRADAS**: Quando o usu√°rio mencionar valores recebidos (ex: "recebi comiss√£o", "sal√°rio", "freelance"), chame a fun√ß√£o save_income. Pergunte apenas o que faltar: valor, descri√ß√£o, conta banc√°ria (se quiser especificar), respons√°vel.

15. **RESUMOS E CONSULTAS**: Quando o usu√°rio perguntar sobre gastos (ex: "quanto gastei?", "resumo de despesas", "quanto j√° gastei de alimenta√ß√£o?"), chame as fun√ß√µes apropriadas:
   - "quanto gastei?" / "resumo de despesas" ‚Üí get_expenses_summary (per√≠odo: este_mes)
   - "quanto gastei de X?" / "quanto j√° gastei de alimenta√ß√£o?" ‚Üí get_category_summary (category: X, period: este_mes)
   - Se o usu√°rio mencionar per√≠odo espec√≠fico (hoje, semana, m√™s), use o per√≠odo correto
```

**Exemplo de adi√ß√£o no prompt:**

```javascript
return `Voc√™ √© o ZUL...

... [regras existentes] ...

CAPACIDADES ADICIONAIS:

- **Registrar Entradas/Receitas**: Se o usu√°rio mencionar valores recebidos (ex: "recebi comiss√£o de 200 reais", "sal√°rio", "freelance"), pergunte os dados necess√°rios e chame save_income. Pergunte: valor, descri√ß√£o, conta banc√°ria (opcional), respons√°vel.

- **Consultar Resumos**: Se o usu√°rio perguntar sobre gastos:
  * "quanto gastei?" ‚Üí get_expenses_summary (period: este_mes)
  * "quanto gastei de X?" ‚Üí get_category_summary (category: X, period: este_mes)
  * "resumo de despesas" ‚Üí get_expenses_summary (period: este_mes)
  
  Se mencionar per√≠odo (hoje, semana, m√™s), use o per√≠odo correto.

... [resto do prompt] ...
`;
```

---

## üìù Exemplos de Uso

### Exemplo 1: Registrar Entrada
```
Usu√°rio: Zul, recebi comiss√£o de 200 reais
ZUL: Beleza! Qual conta adiciono? (ou perguntar se quiser especificar)
Usu√°rio: Nubank
ZUL: [chama save_income]
Resposta: Entrada registrada! ‚úÖ
R$ 200,00 - comiss√£o
Comiss√£o
Nubank
Felipe
Hoje
```

### Exemplo 2: Resumo por Categoria
```
Usu√°rio: Zul, quanto j√° gastei de alimenta√ß√£o esse m√™s?
ZUL: [chama get_category_summary(category: "Alimenta√ß√£o", period: "este_mes")]
Resposta: Voc√™ gastou em Alimenta√ß√£o: R$ 450,00
(15 despesas)
```

### Exemplo 3: Resumo Geral
```
Usu√°rio: Zul, quanto gastei esse m√™s?
ZUL: [chama get_expenses_summary(period: "este_mes")]
Resposta: üí∞ **Resumo de Despesas** (Este M√™s)

**Total: R$ 1.250,00**

‚Ä¢ Alimenta√ß√£o: R$ 450,00 (36,0%)
‚Ä¢ Transporte: R$ 300,00 (24,0%)
‚Ä¢ Casa: R$ 250,00 (20,0%)
‚Ä¢ Sa√∫de: R$ 150,00 (12,0%)
‚Ä¢ Lazer: R$ 100,00 (8,0%)

(45 despesas no total)
```

---

## ‚úÖ Checklist de Implementa√ß√£o

- [ ] Adicionar fun√ß√µes ao `getFunctions()`
- [ ] Implementar handlers no `handleFunctionCall()`
- [ ] Implementar `saveIncome()`
- [ ] Implementar `getExpensesSummary()`
- [ ] Implementar `getCategorySummary()`
- [ ] Adicionar helper `formatPeriod()`
- [ ] Atualizar prompt do ZUL
- [ ] Testar registro de entrada
- [ ] Testar resumos por per√≠odo
- [ ] Testar resumos por categoria
- [ ] Verificar integra√ß√£o com contas banc√°rias

---

## üîç Queries SQL Necess√°rias

As queries j√° est√£o sendo feitas via Supabase client, mas aqui est√£o as SQL equivalentes para refer√™ncia:

### Resumo de Despesas
```sql
SELECT 
  category,
  SUM(amount) as total,
  COUNT(*) as count
FROM expenses
WHERE organization_id = $1
  AND status = 'confirmed'
  AND date >= $2
  AND date <= $3
GROUP BY category
ORDER BY total DESC;
```

### Resumo por Categoria Espec√≠fica
```sql
SELECT 
  SUM(amount) as total,
  COUNT(*) as count
FROM expenses
WHERE organization_id = $1
  AND category = $2
  AND status = 'confirmed'
  AND date >= $3
  AND date <= $4;
```

---

## üö® Considera√ß√µes Importantes

1. **Performance**: Para resumos, considere adicionar √≠ndices nas colunas `date`, `category`, `organization_id` se ainda n√£o existirem.

2. **RLS (Row Level Security)**: Garanta que as queries respeitam as pol√≠ticas RLS do Supabase.

3. **Valida√ß√£o**: Sempre valide `organization_id` e `user_id` nas queries.

4. **Formata√ß√£o**: Use formata√ß√£o brasileira (pt-BR) para valores e datas.

5. **Erros**: Trate erros graciosamente e retorne mensagens amig√°veis.

---

## üìö Pr√≥ximos Passos

Ap√≥s implementar essas funcionalidades b√°sicas, voc√™ pode expandir para:
- Resumos por per√≠odo customizado
- Compara√ß√µes entre per√≠odos
- Gr√°ficos simples (via texto/emoji)
- Alertas de limite de or√ßamento
- An√°lises mais complexas

---

**Arquivo criado em:** `docs/ZUL_NOVAS_FUNCIONALIDADES.md`
**√öltima atualiza√ß√£o:** 31/10/2025

