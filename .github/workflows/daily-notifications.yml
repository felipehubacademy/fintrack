name: Daily Notifications

on:
  schedule:
    # Executa 2x por dia:
    # - 8h BRT (11h UTC) - Manh√£
    # - 20h BRT (23h UTC) - Noite
    - cron: '0 11 * * *'  # 8h BRT
    - cron: '0 23 * * *'  # 20h BRT
    # Executa diariamente √†s 9h UTC (6h BRT) - Notifica√ß√£o do dia do vencimento
    - cron: '0 9 * * *'
  
  # Permite execu√ß√£o manual para testes
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verificar Secrets Configurados
        run: |
          echo "üîç Verificando secrets necess√°rios..."
          echo ""
          
          # Verificar APP_URL
          if [ -z "${{ secrets.APP_URL }}" ]; then
            echo "‚ö†Ô∏è APP_URL n√£o configurado"
            echo "   Usando fallback: https://fintrack-web.vercel.app"
          else
            echo "‚úÖ APP_URL configurado"
          fi
          
          # Verificar CRON_SECRET
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "‚ùå CRON_SECRET n√£o configurado"
            echo "   Configure em: Settings > Secrets and variables > Actions"
            echo ""
            echo "üí° Para gerar um secret:"
            echo "   openssl rand -hex 32"
            echo ""
            echo "‚ö†Ô∏è Workflow continuar√°, mas as chamadas falhar√£o sem autentica√ß√£o"
          else
            echo "‚úÖ CRON_SECRET configurado"
          fi
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
      
      - name: Check Bills Due Tomorrow (Preventivo)
        # Executa nas 2x por dia (8h e 20h BRT) e em execu√ß√µes manuais
        run: |
          echo "üîî Verificando contas vencendo amanh√£..."
          APP_URL="${{ secrets.APP_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$APP_URL" ]; then
            APP_URL="https://www.meuazulao.com.br"
            echo "‚ö†Ô∏è APP_URL n√£o configurado, usando: $APP_URL"
          fi
          
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå CRON_SECRET n√£o configurado no GitHub Secrets"
            echo "üí° Configure em: Settings > Secrets and variables > Actions"
            exit 0
          fi
          
          curl -v -X POST $APP_URL/api/notifications/check-bills-due-tomorrow \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"
        continue-on-error: true
      
      - name: Check Bills Due Today
        # Executa √†s 6h BRT (9h UTC) para notificar contas vencendo hoje
        run: |
          echo "üîî Verificando contas vencendo hoje..."
          APP_URL="${{ secrets.APP_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$APP_URL" ]; then
            APP_URL="https://fintrack-web.vercel.app"
          fi
          
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ö†Ô∏è CRON_SECRET n√£o configurado, pulando..."
            exit 0
          fi
          
          curl -v -X POST $APP_URL/api/notifications/check-bills \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"
        continue-on-error: true
      
      - name: Check Investment Goals
        run: |
          echo "üéØ Verificando metas de investimento..."
          APP_URL="${{ secrets.APP_URL }}"
          CRON_SECRET="${{ secrets.CRON_SECRET }}"
          
          if [ -z "$APP_URL" ]; then
            APP_URL="https://fintrack-web.vercel.app"
          fi
          
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ö†Ô∏è CRON_SECRET n√£o configurado, pulando..."
            exit 0
          fi
          
          curl -v -X POST $APP_URL/api/notifications/check-investments \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}\n"
        continue-on-error: true
      
      - name: Log status
        if: always()
        run: echo "Notifications completed at $(date)"

