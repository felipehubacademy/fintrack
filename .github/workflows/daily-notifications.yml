name: Daily Notifications

on:
  schedule:
    # Executa 2x por dia:
    # - 8h BRT (11h UTC) - ManhÃ£
    # - 20h BRT (23h UTC) - Noite
    - cron: '0 11 * * *'  # 8h BRT
    - cron: '0 23 * * *'  # 20h BRT
    # Executa diariamente Ã s 9h UTC (6h BRT) - NotificaÃ§Ã£o do dia do vencimento
    - cron: '0 9 * * *'
  
  # Permite execuÃ§Ã£o manual para testes
  workflow_dispatch:

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Bills Due Tomorrow (Preventivo)
        # Executa nas 2x por dia (8h e 20h BRT) e em execuÃ§Ãµes manuais
        run: |
          echo "ğŸ”” Verificando contas vencendo amanhÃ£ (preventivo)..."
          
          # Tentar usar APP_URL do secret, ou fallback para URL conhecida
          APP_URL="${APP_URL:-${{ secrets.APP_URL }}}"
          
          if [ -z "$APP_URL" ]; then
            # Fallback para URL conhecida do Vercel
            APP_URL="https://fintrack-web.vercel.app"
            echo "âš ï¸ APP_URL nÃ£o configurado no secret, usando fallback: $APP_URL"
          else
            echo "âœ… APP_URL: $APP_URL"
          fi
          
          if [ -z "${{ secrets.CRON_SECRET }}" ]; then
            echo "âŒ CRON_SECRET nÃ£o configurado no GitHub Secrets"
            echo "ğŸ’¡ Configure em: Settings > Secrets and variables > Actions > CRON_SECRET"
            exit 1
          fi
          
          url="$APP_URL/api/notifications/check-bills-due-tomorrow"
          echo "ğŸ“¡ URL completa: $url"
          echo "ğŸ“¡ Fazendo requisiÃ§Ã£o para o endpoint..."
          
          set +e
          response=$(curl -v -s -w "\n%{http_code}" -X POST \
            "$url" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json" \
            --max-time 30 2>&1)
          curl_exit=$?
          set -e
          
          # Extrair HTTP code (Ãºltima linha que contÃ©m apenas nÃºmeros)
          http_code=$(echo "$response" | grep -E '^[0-9]{3}$' | tail -n1)
          
          # Se nÃ£o encontrou cÃ³digo, tentar extrair do verbose
          if [ -z "$http_code" ]; then
            http_code=$(echo "$response" | grep -iE '< HTTP/[0-9]' | tail -n1 | grep -oE '[0-9]{3}' | tail -n1)
          fi
          
          # Extrair body (tudo exceto linhas de verbose e cÃ³digo HTTP)
          body=$(echo "$response" | grep -v -E '^(< |> |\* |\{|%|^[0-9]{3}$|HTTP|Connection|Host)')
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Status HTTP: ${http_code:-'N/A'}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -n "$body" ]; then
            echo "Resposta:"
            echo "$body" | head -20
          fi
          
          if [ $curl_exit -ne 0 ] && [ -z "$http_code" ]; then
            echo ""
            echo "âŒ Erro ao fazer requisiÃ§Ã£o (curl exit code: $curl_exit)"
            echo "ğŸ’¡ PossÃ­veis causas:"
            echo "  - Endpoint ainda nÃ£o foi deployado no Vercel"
            echo "  - APP_URL incorreto ou endpoint nÃ£o existe"
            echo "  - Problema de conexÃ£o/rede"
            echo ""
            echo "ğŸ” Para verificar:"
            echo "  1. Confirme que o push foi feito e o Vercel fez deploy"
            echo "  2. Verifique se o endpoint aparece em: https://vercel.com/.../fintrack-web"
            exit 1
          fi
          
          if [ "$http_code" = "200" ]; then
            echo ""
            echo "âœ… Sucesso! NotificaÃ§Ãµes enviadas."
          elif [ "$http_code" = "401" ]; then
            echo ""
            echo "âš ï¸ Erro de autenticaÃ§Ã£o (HTTP 401). Verifique o CRON_SECRET."
            exit 1
          elif [ "$http_code" = "404" ] || [ "$http_code" = "405" ]; then
            echo ""
            echo "âš ï¸ Endpoint nÃ£o encontrado ou mÃ©todo nÃ£o permitido (HTTP $http_code)"
            echo "ğŸ’¡ Isso pode indicar que o endpoint ainda nÃ£o foi deployado ou hÃ¡ problema de build."
            echo "ğŸ’¡ Aguarde alguns minutos e tente novamente apÃ³s o deploy completar."
            exit 1
          elif [ -n "$http_code" ] && [ "$http_code" != "200" ]; then
            echo ""
            echo "âŒ Erro: HTTP $http_code"
            exit 1
          fi
          
          echo "âœ… VerificaÃ§Ã£o preventiva de contas concluÃ­da"
      
      - name: Check Bills Due Today
        # Executa Ã s 6h BRT (9h UTC) para notificar contas vencendo hoje
        run: |
          echo "ğŸ”” Verificando contas vencendo hoje..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.APP_URL }}/api/notifications/check-bills" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ Erro ao verificar contas: HTTP $http_code"
            exit 1
          fi
          
          echo "âœ… VerificaÃ§Ã£o de contas concluÃ­da"
      
      - name: Check Investment Goals
        run: |
          echo "ğŸ¯ Verificando metas de investimento..."
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.APP_URL }}/api/notifications/check-investments" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ Erro ao verificar metas: HTTP $http_code"
            exit 1
          fi
          
          echo "âœ… VerificaÃ§Ã£o de metas concluÃ­da"
      
      - name: Notification Summary
        if: always()
        run: |
          echo "ğŸ“Š Resumo das NotificaÃ§Ãµes"
          echo "=========================="
          echo "âœ… Job concluÃ­do!"
          echo ""
          echo "Logs disponÃ­veis acima para detalhes."

